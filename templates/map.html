{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-4 mb-5 position-relative">
  <h2 class="text-center fw-bold mb-4 text-primary">üó∫Ô∏è –ú–∞–ø–∞ –∑–Ω–∏–∫–ª–∏—Ö –ª—é–¥–µ–π</h2>

  <!-- üîπ –ü–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–∑–∞–º—ñ—Å—Ç—å select, –∞–ª–µ –∑ Django GET –ª–æ–≥—ñ–∫–æ—é) -->
  <div class="filters text-center mb-3">
    <button class="btn btn-outline-primary m-1" data-category="all">üåç –£—Å—ñ</button>
    <button class="btn btn-outline-warning m-1" data-category="–î–∏—Ç–∏–Ω–∞">üë∂ –î—ñ—Ç–∏</button>
    <button class="btn btn-outline-success m-1" data-category="–î–æ—Ä–æ—Å–ª–∏–π">üßç‚Äç‚ôÇÔ∏è –î–æ—Ä–æ—Å–ª—ñ</button>
    <button class="btn btn-outline-info m-1" data-category="–í—ñ–π—Å—å–∫–æ–≤–∏–π">üéñÔ∏è –í—ñ–π—Å—å–∫–æ–≤—ñ</button>
    <button class="btn btn-outline-secondary m-1" data-category="–õ—ñ—Ç–Ω—è –ª—é–¥–∏–Ω–∞">üë¥ –õ—ñ—Ç–Ω—ñ</button>
    <button class="btn btn-outline-light border m-1" data-category="–õ—é–¥–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é">‚ôø –Ü–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å</button>
  </div>

  <!-- üó∫Ô∏è –ú–∞–ø–∞ -->
  <div id="map" style="height: 75vh; border-radius: 12px; overflow:hidden;"></div>

  <!-- üóíÔ∏è –õ–µ–≥–µ–Ω–¥–∞ -->
  <div id="legend" class="card shadow p-2 position-absolute bottom-0 end-0 m-3"
       style="z-index:1000; font-size:0.9em; color:#000;">
    <strong style="color:#000;">üîé –°—Ç–∞—Ç—É—Å:</strong><br>
    <span style="color:#f39c12;">‚óè –£ —Ä–æ–∑—à—É–∫—É</span><br>
    <span style="color:#2ecc71;">‚óè –ó–Ω–∞–π–¥–µ–Ω–æ</span><br>
    <span style="color:#e74c3c;">‚óè –Ü–Ω—à–µ</span>
  </div>
</div>

<!-- ‚úÖ Leaflet —ñ MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<!-- ‚úÖ –ë–µ–∑–ø–µ—á–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–∏—Ö -->
{{ persons|json_script:"persons_data" }}

<script>
document.addEventListener("DOMContentLoaded", function() {
  const personsData = JSON.parse(document.getElementById("persons_data").textContent);

  // üó∫Ô∏è –ö–∞—Ä—Ç–∞
  const map = L.map("map").setView([49.0, 32.0], 6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // üß© –ö–ª–∞—Å—Ç–µ—Ä –≥—Ä—É–ø–∞
  const markers = L.markerClusterGroup();

  // ü™∂ –î–æ–¥–∞—î–º–æ –º—ñ—Ç–∫–∏
  personsData.forEach(p => {
    if (p.latitude && p.longitude) {
      const color =
        p.status === "found"
          ? "#2ecc71"
          : p.status === "missing"
          ? "#f39c12"
          : "#e74c3c";

      const marker = L.circleMarker([p.latitude, p.longitude], {
        color,
        fillColor: color,
        radius: 8,
        fillOpacity: 0.9,
        weight: 1
      }).bindPopup(`
        <div style="min-width:200px; text-align:center;">
          ${p.photo ? `<img src="${p.photo}" alt="${p.full_name}" style="width:100%; max-height:120px; object-fit:cover; border-radius:8px; margin-bottom:6px;">` : ''}
          <h6 class="fw-semibold mb-1" style="color:#000;">${p.full_name}</h6>
          <p class="mb-1 text-muted" style="font-size: 0.9em;">
            <i class="bi bi-geo-alt"></i> ${p.city}, ${p.region}
          </p>
          <p class="mb-2"><span class="badge bg-primary">${p.category}</span></p>
          <a href="/person/${p.id}/" class="btn btn-sm btn-outline-primary w-100">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
        </div>
      `);

      markers.addLayer(marker);
    }
  });

  map.addLayer(markers);

  // üß≠ –õ–æ–≥—ñ–∫–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Django GET –ø–∞—Ä–∞–º–µ—Ç—Ä
  const currentCategory = new URLSearchParams(window.location.search).get("category") || "all";

  document.querySelectorAll(".filters button").forEach(btn => {
    const btnCategory = btn.dataset.category;

    // –ø—ñ–¥—Å–≤—ñ—á—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –∫–Ω–æ–ø–∫—É
    if (btnCategory === currentCategory) {
      btn.classList.remove("btn-outline-*");
      btn.classList.add("btn-primary", "text-white");
    }

    // –∫–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ ‚Äî —Ä–æ–±–∏–º–æ –ø–µ—Ä–µ—Ö—ñ–¥ —ñ–∑ GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
    btn.addEventListener("click", () => {
      const params = new URLSearchParams(window.location.search);
      params.set("category", btnCategory);
      window.location.search = params.toString();
    });
  });
});
</script>

<style>
  /* üåó –¢–µ–º–Ω–∞ —Ç–µ–º–∞ ‚Äî —ñ–Ω–≤–µ—Ä—Å—ñ—è –∫–∞—Ä—Ç–∏ */
  body[data-theme="dark"] #map {
    filter: invert(0.9) hue-rotate(180deg) brightness(0.9);
    transition: filter 0.6s ease;
  }

  /* üé® –ö–Ω–æ–ø–∫–∏ */
  .filters button {
    border-radius: 8px;
    min-width: 110px;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
  }
  .filters button:hover {
    transform: translateY(-2px);
  }

  /* ‚ôø –ö–Ω–æ–ø–∫–∞ "–Ü–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å" ‚Äî –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞ —É —Ç–µ–º–Ω—ñ–π —Ç–µ–º—ñ */
  body[data-theme="dark"] .filters button[data-category="–õ—é–¥–∏–Ω–∞ –∑ —ñ–Ω–≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—é"] {
    background-color: #555 !important;
    color: #fff !important;
    border-color: #777 !important;
  }

  /* üóíÔ∏è –ü–æ–ø–∞–ø */
  .leaflet-popup-content-wrapper,
  .leaflet-popup-tip {
    background: #fff !important;
    color: #000 !important;
  }

  body[data-theme="dark"] .leaflet-popup-content-wrapper,
  body[data-theme="dark"] .leaflet-popup-tip {
    background: #fff !important;
    color: #000 !important;
  }

  /* üåÄ Hover-–∞–Ω—ñ–º–∞—Ü—ñ—è */
  .leaflet-interactive:hover {
    cursor: pointer;
    stroke-width: 2;
    stroke: #000;
    r: 10 !important;
  }

  /* üß≠ –õ–µ–≥–µ–Ω–¥–∞ */
  #legend {
    backdrop-filter: blur(8px);
    background-color: rgba(255,255,255,0.9);
    color: #000 !important;
  }
</style>
{% endblock %}
