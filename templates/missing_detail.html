{% extends 'base.html' %}
{% block content %}
<div class="card mb-4 border-0 shadow-sm rounded-4">
  {% if person.photo %}
  <div class="text-center mb-3">
    <img src="{{ person.photo.url }}" alt="{{ person.full_name }}"
         class="img-fluid rounded-4 shadow-sm"
         style="max-height: 600px; width: auto; object-fit: cover;">
  </div>
  {% endif %}

  <div class="card-body">
    <h3 class="fw-bold text-primary mb-3">{{ person.full_name }}</h3>

    <!-- üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä—ñ—è + —Å—Ç–∞—Ç—É—Å -->
    <p class="mb-3">
      {% if person.category %}
        <span class="badge bg-info text-dark px-3 py-2">{{ person.get_category_display }}</span>
      {% endif %}
      {% if person.status %}
        <span class="badge {% if person.status == 'found' %}bg-success{% else %}bg-danger{% endif %} px-3 py-2">
          {{ person.get_status_display }}
        </span>
      {% endif %}
    </p>

    <p><strong>–†–µ–≥—ñ–æ–Ω:</strong> {{ person.region }}</p>
    <p><strong>–ú—ñ—Å—Ç–æ:</strong> {{ person.city }}</p>
    <p><strong>–î–∞—Ç–∞ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è:</strong> {{ person.missing_date }}</p>
    <p><strong>–û–ø–∏—Å:</strong> {{ person.description }}</p>

    {% if person.location %}
    <p><strong>–ú—ñ—Å—Ü–µ, –¥–µ –±–∞—á–∏–ª–∏:</strong> {{ person.location }}</p>
    {% endif %}

    {% if user == person.user or user.is_superuser %}
    <div class="mt-4">
      <a href="{% url 'edit_missing' person.pk %}" class="btn btn-warning me-2 shadow-sm">
        ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
      </a>
      <a href="{% url 'delete_missing' person.pk %}" class="btn btn-danger shadow-sm"
         onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è?')">
        üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- üó∫Ô∏è –ú–∞–ø–∞ -->
{% if person.latitude and person.longitude %}
<h5 class="mt-4 mb-2">üìç –û—Å—Ç–∞–Ω–Ω—î –º—ñ—Å—Ü–µ, –¥–µ –±–∞—á–∏–ª–∏</h5>
<div id="map" style="height: 300px; border-radius: 10px;" class="mb-4 shadow-sm"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const lat = parseFloat('{{ person.latitude|default:"0" }}');
  const lng = parseFloat('{{ person.longitude|default:"0" }}');

  if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
    const map = L.map('map').setView([lat, lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([lat, lng]).addTo(map)
      .bindPopup("{{ person.full_name|escapejs }}")
      .openPopup();
  }
});
</script>
{% endif %}

<!-- üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
<div class="card p-4 shadow-sm border-0 rounded-4 mt-4 mb-5">
  <h4 class="fw-semibold mb-3">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h4>

  {% if user.is_authenticated %}
  <form method="post" class="mb-3">
    {% csrf_token %}
    <textarea name="text" class="form-control mb-2 rounded-3" rows="3" placeholder="–ó–∞–ª–∏—à—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä..." required></textarea>
    <button type="submit" class="btn btn-primary w-100 rounded-3 fw-semibold shadow-sm">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
  </form>
  {% else %}
  <p><a href="/login/">–£–≤—ñ–π–¥—ñ—Ç—å</a>, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä.</p>
  {% endif %}

  {% for c in comments %}
  <div class="comment-box mb-3 p-3 rounded-4" 
       style="background-color: var(--card-bg, #f8f9fa); transition: background-color 0.3s;">
    <strong>{{ c.user.username }}</strong>
    <small class="d-block opacity-75">{{ c.created_at|date:"d.m.Y H:i" }}</small>
    <p class="mt-2 mb-0">{{ c.text }}</p>
  </div>
  {% empty %}
  <p>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>
  {% endfor %}
</div>

<style>
  /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ */
  [data-theme='dark'] .comment-box {
    background-color: #1e1e2e !important;
    color: #f1f1f1 !important;
  }
</style>
{% endblock %}
