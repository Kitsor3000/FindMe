{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <div class="text-center mb-5">
    <h1 class="fw-bold display-5 text-primary mb-2">üìä –ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    <p class="lead text-muted">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –∑–Ω–∏–∫–ª–∏—Ö –æ—Å—ñ–±, —Ä–µ–≥—ñ–æ–Ω—ñ–≤ —ñ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>
  </div>

  <!-- üïí –§—ñ–ª—å—Ç—Ä —á–∞—Å—É -->
  <div class="text-center mb-4">
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-primary active" data-period="week">–¢–∏–∂–¥–µ–Ω—å</button>
      <button type="button" class="btn btn-outline-primary" data-period="month">–ú—ñ—Å—è—Ü—å</button>
      <button type="button" class="btn btn-outline-primary" data-period="year">–†—ñ–∫</button>
    </div>
  </div>

  <!-- üìà –ì—Ä–∞—Ñ—ñ–∫–∏ -->
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="chart-card p-4 rounded-4 shadow-sm">
        <h5 class="fw-semibold mb-3 text-dark">üìä –†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º</h5>
        <canvas id="statusChart" height="200"></canvas>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="chart-card p-4 rounded-4 shadow-sm">
        <h5 class="fw-semibold mb-3 text-dark">üó∫Ô∏è –†–µ–≥—ñ–æ–Ω–∏ –∑ –Ω–∞–π–±—ñ–ª—å—à–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –æ–≥–æ–ª–æ—à–µ–Ω—å</h5>
        <canvas id="regionChart" height="300"></canvas>
      </div>
    </div>

    <div class="col-lg-12">
      <div class="chart-card p-4 rounded-4 shadow-sm mt-4">
        <h5 class="fw-semibold mb-3 text-dark">üìÜ –ù–æ–≤—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h5>
        <canvas id="weeklyChart" height="90"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const COLORS = {
    missing: '#FF1493',
    found: '#00FF7F',
    other: '#48D1CC',
    text: '#000000',
    others: '#6A5ACD'
  };

  let statusChart, regionChart, weeklyChart;

  // ‚öôÔ∏è –§—É–Ω–∫—Ü—ñ—è —Ä–µ–Ω–¥–µ—Ä—É –¥—ñ–∞–≥—Ä–∞–º
  function renderCharts(data) {
    const { status_data, region_data, weekly_data } = data;

    if (statusChart) statusChart.destroy();
    if (regionChart) regionChart.destroy();
    if (weeklyChart) weeklyChart.destroy();

    // üü£ –°—Ç–∞—Ç—É—Å–∏
    statusChart = new Chart(document.getElementById('statusChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(status_data),
        datasets: [{
          data: Object.values(status_data),
          backgroundColor: [COLORS.missing, COLORS.found, COLORS.other],
          borderWidth: 0
        }]
      },
      options: { plugins: { legend: { position: 'bottom', labels: { color: COLORS.text } } } }
    });

    // üîµ –†–µ–≥—ñ–æ–Ω–∏ (–∑ –Ω–∞—Ö–∏–ª–µ–Ω–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏)
    regionChart = new Chart(document.getElementById('regionChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(region_data),
        datasets: [{
          data: Object.values(region_data),
          backgroundColor: COLORS.other,
          borderRadius: 10
        }]
      },
      options: {
        scales: {
          x: {
            ticks: {
              color: COLORS.text,
              maxRotation: 45, // üëà –Ω–∞—Ö–∏–ª–µ–Ω–æ
              minRotation: 45,
              autoSkip: false,
              font: { size: 12 }
            },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: {
              color: COLORS.text,
              callback: v => Number.isInteger(v) ? v : '',
              stepSize: 1
            },
            grid: { color: 'rgba(0,0,0,0.1)' }
          }
        },
        plugins: { legend: { display: false } }
      }
    });

    // üü¢ –¢—Ä–µ–Ω–¥ –Ω–æ–≤–∏—Ö
    weeklyChart = new Chart(document.getElementById('weeklyChart'), {
      type: 'line',
      data: {
        labels: Object.keys(weekly_data),
        datasets: [{
          label: '–ù–æ–≤—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è',
          data: Object.values(weekly_data),
          fill: true,
          borderColor: COLORS.others,
          backgroundColor: 'rgba(72, 61, 139, 0.15)',
          tension: 0.35,
          pointRadius: 4
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: COLORS.text } },
          y: {
            beginAtZero: true,
            ticks: {
              color: COLORS.text,
              callback: v => Number.isInteger(v) ? v : '',
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // üïì –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö (—Ç–∏–∂–¥–µ–Ω—å)
  fetch("{% url 'chart_data' %}?period=week")
    .then(r => r.json())
    .then(data => renderCharts(data));

  // üîò –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
  document.querySelectorAll('[data-period]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const period = btn.dataset.period;
      fetch("{% url 'chart_data' %}?period=" + period)
        .then(r => r.json())
        .then(data => renderCharts(data));
    });
  });
</script>

<style>
  body, .chart-card { color: #000 !important; }
  .chart-card { background-color: var(--bs-body-bg); border: none; transition: all 0.3s ease; }
  body[data-theme='dark'] .chart-card { background-color: #f9f9f9; }
  .btn-group .btn.active { background-color: #0d6efd; color: #fff; }
  footer { margin-top: 80px !important; }
</style>
{% endblock %}
